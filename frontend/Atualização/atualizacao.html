<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atualiza√ß√£o de Progresso - GhostTrack</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="./atualizacao.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="../Home/home.html">
                <i class="fas fa-ghost"></i> GhostTrack
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="../Home/home.html"><i class="fas fa-home"></i> Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="../QS/qs.html"><i class="fas fa-users"></i> Quem Somos</a></li>
                    <li class="nav-item"><a class="nav-link" href="../Cadastro/cadastro.html"><i class="fas fa-user-plus"></i> Cadastro</a></li>
                    <li class="nav-item"><a class="nav-link" href="../Consulta/consulta.html"><i class="fas fa-search"></i> Consulta</a></li>
                    <li class="nav-item"><a class="nav-link active" href="./atualizacao.html"><i class="fas fa-edit"></i> Atualiza√ß√£o</a></li>
                    <li class="nav-item"><a class="nav-link" href="../Exclusao/exclusao.html"><i class="fas fa-trash"></i> Exclus√£o</a></li>
                    <li class="nav-item"><a class="nav-link" href="../Relatorios/relatorios.html"><i class="fas fa-chart-bar"></i> Relat√≥rios</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <section class="page-header">
        <div class="container">
            <h1><i class="fas fa-chart-line"></i> Atualizar Progresso</h1>
            <p>Registre seus avan√ßos nas metas ativas</p>
        </div>
    </section>

    <section class="update-section">
        <div class="container">
            <div class="update-container">
                
                <div class="select-goal-card" id="selectGoalCard">
                    <h2><i class="fas fa-list"></i> Selecione a Meta</h2>
                    <div class="goal-selector" id="goalSelectorContainer">
                        <div class="text-center p-5">
                            <div class="spinner-border text-primary"></div>
                        </div>
                    </div>
                </div>

                <div class="update-form-card" id="updateFormCard">
                    <div class="form-header">
                        <h3 id="selectedGoalTitle">Meta Selecionada</h3>
                        <p id="selectedGoalCategory"></p>
                    </div>

                    <div class="current-progress">
                        <h5><i class="fas fa-chart-bar"></i> Progresso Atual</h5>
                        <div class="progress">
                            <div class="progress-bar" id="currentProgressBar" style="width: 0%">0%</div>
                        </div>
                        <div class="progress-stats">
                            <span id="currentValue">0</span>
                            <span id="targetValue">0</span>
                        </div>
                    </div>

                    <div id="alertContainer"></div>

                    <form id="updateForm">
                        <div class="mb-4">
                            <label for="progressValue" class="form-label">
                                <i class="fas fa-plus-circle"></i> Adicionar ao Progresso
                            </label>
                            <div class="input-with-unit">
                                <input type="number" class="form-control" id="progressValue" placeholder="Digite o valor" min="0" step="0.01" required>
                                <span class="unit-label" id="unitLabel">unidade</span>
                            </div>
                            <small class="text-muted">Quanto voc√™ progrediu desde a √∫ltima atualiza√ß√£o?</small>
                            <div class="quick-add-buttons">
                                <button type="button" class="quick-add-btn" data-value="1">+1</button>
                                <button type="button" class="quick-add-btn" data-value="5">+5</button>
                                <button type="button" class="quick-add-btn" data-value="10">+10</button>
                                <button type="button" class="quick-add-btn" data-value="50">+50</button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="updateDate" class="form-label">Data do Progresso</label>
                            <input type="date" class="form-control" id="updateDate" required>
                        </div>

                        <div class="note-section">
                            <label for="progressNote" class="form-label">Observa√ß√µes (opcional)</label>
                            <textarea class="form-control" id="progressNote" rows="3"></textarea>
                        </div>

                        <button type="submit" class="btn btn-submit"><i class="fas fa-save"></i> Salvar Progresso</button>
                        <button type="button" class="btn btn-back" id="btnBack"><i class="fas fa-arrow-left"></i> Voltar</button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom"><p>&copy; 2025 GhostTrack.</p></div>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        import { listarMetas, atualizarMeta } from '../js/api.js';

        let selectedGoal = null;
        const usuarioId = 1;

        window.addEventListener('load', async () => {
            await carregarMetas();
            
            const urlParams = new URLSearchParams(window.location.search);
            const goalIdParam = urlParams.get('id');
            if (goalIdParam) {
                const metaAlvo = document.querySelector(`.goal-option[data-goal-id="${goalIdParam}"]`);
                if (metaAlvo) metaAlvo.click();
            }
        });

        async function carregarMetas() {
            const container = document.getElementById('goalSelectorContainer');
            if(!container) return; 

            try {
                const resultado = await listarMetas(usuarioId);
                container.innerHTML = ''; 

                if (!resultado || !resultado.success || resultado.data.length === 0) {
                    container.innerHTML = '<p class="text-center p-4">Nenhuma meta encontrada.</p>';
                    return;
                }

                const metasAtivas = resultado.data.filter(m => !isConcluida(m));

                if (metasAtivas.length === 0) {
                    container.innerHTML = `
                        <div class="text-center p-4">
                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                            <p>Parab√©ns! Todas as suas metas foram conclu√≠das.</p>
                            <a href="../Cadastro/cadastro.html" class="btn btn-outline-primary btn-sm">Criar Nova Meta</a>
                        </div>
                    `;
                    return;
                }

                metasAtivas.forEach(meta => {
                    const html = criarHTMLOpcao(meta);
                    container.innerHTML += html;
                });

                adicionarEventosClique();

            } catch (error) {
                container.innerHTML = '<div class="alert alert-danger">Erro ao carregar lista.</div>';
            }
        }

        function isConcluida(meta) {
            const progresso = parseFloat(meta.progresso || 0);
            const valorTotal = parseFloat(meta.valor || 1);
            return meta.status === 'concluida' || progresso >= valorTotal;
        }

        function criarHTMLOpcao(meta) {
            const progresso = parseFloat(meta.progresso || 0);
            const alvo = parseFloat(meta.valor || 1);
            const porcentagem = Math.round((progresso / alvo) * 100);
            
            let icon = 'fa-user';
            if(meta.categoria === 'saude') icon = 'fa-heartbeat';
            if(meta.categoria === 'estudos') icon = 'fa-graduation-cap';
            if(meta.categoria === 'financas') icon = 'fa-dollar-sign';

            return `
                <div class="goal-option" 
                     data-goal-id="${meta.id}" 
                     data-titulo="${meta.titulo}"
                     data-descricao="${meta.descricao || ''}"
                     data-categoria="${meta.categoria}"
                     data-current="${progresso}" 
                     data-target="${alvo}" 
                     data-unit="${meta.unidade}">
                    
                    <div class="goal-info">
                        <h4>${meta.titulo}</h4>
                        <small><i class="fas ${icon}"></i> ${meta.categoria.toUpperCase()}</small>
                    </div>
                    <div class="goal-progress">
                        <div class="progress-badge">${porcentagem}%</div>
                        <small>${progresso} / ${alvo} ${meta.unidade}</small>
                    </div>
                </div>
            `;
        }

        function adicionarEventosClique() {
            document.querySelectorAll('.goal-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.goal-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');

                    selectedGoal = {
                        id: this.dataset.goalId,
                        title: this.dataset.titulo,
                        description: this.dataset.descricao,
                        category: this.dataset.categoria,
                        current: parseFloat(this.dataset.current),
                        target: parseFloat(this.dataset.target),
                        unit: this.dataset.unit
                    };

                    document.getElementById('selectGoalCard').style.display = 'none';
                    document.getElementById('updateFormCard').classList.add('active');

                    document.getElementById('selectedGoalTitle').textContent = selectedGoal.title;
                    document.getElementById('selectedGoalCategory').textContent = selectedGoal.category.toUpperCase();
                    document.getElementById('unitLabel').textContent = selectedGoal.unit;

                    const percentage = Math.round((selectedGoal.current / selectedGoal.target) * 100);
                    const bar = document.getElementById('currentProgressBar');
                    bar.style.width = percentage + '%';
                    bar.textContent = percentage + '%';
                    
                    document.getElementById('currentValue').textContent = `${selectedGoal.current} ${selectedGoal.unit}`;
                    document.getElementById('targetValue').textContent = `${selectedGoal.target} ${selectedGoal.unit}`;
                });
            });
        }

        document.getElementById('btnBack').addEventListener('click', function() {
            document.getElementById('selectGoalCard').style.display = 'block';
            document.getElementById('updateFormCard').classList.remove('active');
            document.getElementById('updateForm').reset();
            window.history.pushState({}, document.title, window.location.pathname);
        });

        document.querySelectorAll('.quick-add-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const value = parseFloat(this.dataset.value);
                const input = document.getElementById('progressValue');
                const currentValue = parseFloat(input.value) || 0;
                input.value = currentValue + value;
            });
        });

        document.getElementById('updateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!selectedGoal) return;

            const addValue = parseFloat(document.getElementById('progressValue').value);
            const newProgress = selectedGoal.current + addValue;
            
            let novoStatus = 'em_andamento';
            if (newProgress >= selectedGoal.target) novoStatus = 'concluida';

            try {
                const resultado = await atualizarMeta(
                    selectedGoal.id,
                    selectedGoal.title,
                    selectedGoal.description,
                    novoStatus,
                    newProgress
                );

                if (resultado && (resultado.success || resultado.message)) {
                    showAlert('‚úÖ Progresso salvo! ' + (novoStatus === 'concluida' ? 'üéâ Meta Conclu√≠da!' : ''), 'success');
                    setTimeout(() => window.location.href = '../Consulta/consulta.html', 2000);
                } else {
                    showAlert('Erro ao atualizar.', 'danger');
                }
            } catch (error) {
                showAlert('Erro de conex√£o.', 'danger');
            }
        });

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        document.getElementById('updateDate').valueAsDate = new Date();
    </script>
</body>
</html>